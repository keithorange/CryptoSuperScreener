{% extends 'base.html' %}

{% block head %}
<link rel="stylesheet" href="{{ url_for('static', filename='css/watcher.css') }}">

{% endblock %}


{% block content %}
<h1>Watcher Page</h1>

<button onclick="refreshWatcherData()">Refresh Charts</button>

<div class="grid-settings">
    <input type="number" id="gridRows" placeholder="Rows" min="1" value="{{ grid_rows }}">
    <input type="number" id="gridCols" placeholder="Columns" min="1" value="{{ grid_cols }}">
    <button onclick="applyGridSettings()">Apply</button>
</div>

<div class="grid" id="watcherGrid" style="--grid-rows: {{ grid_rows }}; --grid-cols: {{ grid_cols }};"></div>

<div class="pagination">
    {% set items_per_page = grid_rows * grid_cols %}
    {% set total_pages = (favorites|length + items_per_page - 1) // items_per_page %}
    {% for i in range(1, total_pages + 1) %}
    <a href="{{ url_for('watcher', page=i, grid_rows=grid_rows, grid_cols=grid_cols) }}">{{ i }}</a>
    {% endfor %}
</div>


<script src="{{ url_for('static', filename='helpers.js') }}"></script>
<script>
    var favorites = {{ favorites | tojson }};

    document.addEventListener('DOMContentLoaded', () => {
        const favoritePairsData = JSON.parse('{{ favorite_pairs_data | tojson | safe }}');
        populateWatcherCharts(favoritePairsData);
        populateGrid();
    });

  function populateGrid() {
        const rows = parseInt(document.getElementById('gridRows').value, 10) || 2;
        const cols = parseInt(document.getElementById('gridCols').value, 10) || 2;
        const itemsPerPage = rows * cols;
        const currentPage = parseInt(new URLSearchParams(window.location.search).get('page') || '1', 10);
        const startIndex = (currentPage - 1) * itemsPerPage;
        const endIndex = startIndex + itemsPerPage;

        // Slice the favorites array to get only the items for the current page
        const favoritesForPage = favorites.slice(startIndex, endIndex);

        const container = document.getElementById('watcherGrid');
        container.innerHTML = '';
        favoritesForPage.forEach(pair => {
            const gridItem = document.createElement('div');
            gridItem.classList.add('grid-item');
            gridItem.innerHTML = `
            <h2>${pair}</h2>
            <div id="watcher_chart_${pair}" style="width: 400px; height: 300px;"></div>
            <button onclick="removeFavorite('${pair}')">Remove from Favorites</button>
        `;
            container.appendChild(gridItem);
        });
    }

    function applyGridSettings() {
        const rows = parseInt(document.getElementById('gridRows').value, 10) || 2;
        const cols = parseInt(document.getElementById('gridCols').value, 10) || 2;
        window.location.href = `${window.location.pathname}?page=1&grid_rows=${rows}&grid_cols=${cols}`;
    }

    function populateWatcherCharts(favoritePairsData) {
        console.log('Populating watcher charts:', favoritePairsData);

        if (Array.isArray(favoritePairsData)) {
            // Handle array input
            favoritePairsData.forEach(({ pair, ohlcv }) => {
                setTimeout(() => {
                    generateFullChart(pair, ohlcv);
                }, 0);
            });
        } else {
            // Handle object input
            Object.entries(favoritePairsData).forEach(([pair, ohlcvData]) => {
                setTimeout(() => {
                    generateFullChart(pair, ohlcvData);
                }, 0);
            });
        }
    }


    async function refreshWatcherData() {
        document.getElementById('loadingIndicator').style.display = 'block';
        try {
            const response = await fetch('/get_enriched_ohlcv', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ pairs: favorites })
            });
            if (!response.ok) throw new Error('Failed to fetch enriched data');
            const enrichedData = await response.json();
            populateWatcherCharts(enrichedData);
        } catch (error) {
            console.error('Error refreshing watcher data:', error);
        } finally {
            document.getElementById('loadingIndicator').style.display = 'none';
        }
    }

    async function removeFavorite(pair) {
        const response = await fetch('/remove_favorites', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ pair }),
            credentials: 'same-origin'
        });

        if (response.ok) {
            location.reload();
        } else {
            console.error('Error removing favorite:', pair);
        }
    }
</script>

{% endblock %}
